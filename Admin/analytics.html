<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <title>Website-Analytics</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      padding: 2rem;
      max-width: 800px;
      margin: auto;
      background-color: gray;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    .stat {
      background: rgb(234, 234, 234);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .visit-entry {
      border-top: 1px solid #eee;
      padding-top: 0.5rem;
      margin-top: 0.5rem;
      border-bottom: 1px gray solid;
    }

    .access-denied {
      text-align: center;
      padding: 50px;
      background: #f8d7da;
      color: #721c24;
      border-radius: 10px;
      margin: 20px;
      border: 1px solid #f5c6cb;
    }

    .access-denied h1 {
      color: #721c24;
      margin-bottom: 20px;
    }
  </style>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    import { supabaseKey } from "./config.js";

    // Zugangskontrolle
    async function checkAccess() {
      const username = localStorage.getItem('username');
      const password = localStorage.getItem('password');
      if (!username) {
        document.body.innerHTML = `<div class="access-denied"> 
          <h1>ğŸš« Zugang verweigert</h1> 
          <p>Du hast keine Berechtigung, diese Seite zu besuchen.</p>
          </div>`;
        return false;
      }
      try {
        const { data, error } =
          await supabase.functions.invoke('isAdmin', { body: { localusername: username, password: password }, })
        if (!data.valid) {
          document.body.innerHTML = `<div class="access-denied"> 
            <h1>ğŸš« Zugang verweigert</h1> 
            <p>Du hast keine Berechtigung, diese Seite zu besuchen.</p>
            </div>`;
          return false;
        }
        return true;
      }
      catch {
        document.body.innerHTML =
          `<div class="access-denied">
            <h1>âš ï¸ Fehler</h1>
            <p>ÃœberprÃ¼fung nicht mÃ¶glich.</p>
          </div>`; return false;
      }
    }

    async function ladeAnalytics() {
      const container = document.getElementById("besuche");
      container.innerHTML = "Lade Analytics-Daten...";

      try {
        const res = await fetch("/.netlify/functions/get-analytics");
        const data = await res.json();

        if (!Array.isArray(data)) {
          container.innerHTML = "Fehler beim Laden";
          return;
        }

        container.innerHTML = "";
        data.forEach(entry => {
          const div = document.createElement("div");
          div.className = "visit-entry";
          div.innerHTML = `
        <p><strong>ID:</strong> ${entry.id}</p>
        <p>ğŸ•“ Zeit: ${entry.zeit || entry.datum}</p>
        <p>ğŸ§­ Browser: ${entry.browser}</p>
        <p>ğŸ“± GerÃ¤t: ${entry.device}</p>
        <p>ğŸŒ Website: ${entry.link}</p>
        <p>ğŸ‘¤ Person: ${entry.username}</p>
        <p>âš¡ Aktion: ${entry.action}</p>
      `;
          container.appendChild(div);
        });

      } catch (e) {
        container.innerHTML = "Serverfehler";
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      (async () => {
        if (await checkAccess()) {
          ladeAnalytics();
        }
      })();
    });


    const filterBtn = document.getElementById("filterbt");

    filterBtn.addEventListener("click", () => {
      filterActive = !filterActive;
      filterBtn.style.backgroundColor = filterActive ? "lightgreen" : "red";
      ladeAnalytics();
    });
  </script>
</head>

<body>
  <button id="testBtn">Variable abrufen</button>
  <pre id="output"></pre>
  <h1>ğŸ“Š Analytics-EintrÃ¤ge</h1>
  <button id="filterbt"
    style="background-color: red; border-radius: 30px; border:none; padding: 10px 30px; left: 50%; transform: translate(-50%); position: absolute; cursor: pointer;">Filtern</button>
  <div class="stat">
    <h2>Letzte Besuche (Supabase)</h2>
    <div id="besuche"></div>
  </div>

  <script>
    document.getElementById("testBtn").addEventListener("click", async () => {
      const res = await fetch("/./.netlify/functions/test-env");
      const data = await res.json();
      document.getElementById("output").textContent = JSON.stringify(data, null, 2);
    });
  </script>
</body>

</html>